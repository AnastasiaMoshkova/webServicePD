<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <title>Hand Tracking WebSocket</title>
    <style>
        nav {
            background-color: #2c3e50;
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 5px;
            transition: all 0.3s;
        }

        nav a:hover {
            background-color: #3498db;
        }

        nav a.active {
            background-color: #2980b9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
        }

        .container {
            text-align: center;
            max-width: 800px;
            width: 100%;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .video-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .video-box label {
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        video,
        img {
            border-radius: 10px;
            background: #000;
            width: 640px;
            height: 480px;
            object-fit: cover;
        }

        .controls {
            margin: 20px 0;
        }

        .settings {
            margin-top: 20px;
            text-align: left;
            padding: 15px;
            background: #f1f3f4;
            border-radius: 8px;
        }

        .settings label {
            display: block;
            margin-bottom: 8px;
        }

        .settings input[type="range"] {
            width: 100%;
            margin-bottom: 15px;
        }

        .settings-value {
            float: right;
            font-weight: bold;
        }

        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            transition: all 0.3s;
        }

        #startBtn {
            background: #3498db;
            color: white;
        }

        #startBtn:hover {
            background: #2980b9;
        }

        #stopBtn {
            background: #e74c3c;
            color: white;
            display: none;
        }

        #stopBtn:hover {
            background: #c0392b;
        }

        #recordBtn {
            background: #9b59b6;
            color: white;
        }

        #recordBtn:hover {
            background: #8e44ad;
        }

        #recordBtn.recording {
            background: #2ecc71;
        }

        #recordBtn.recording:hover {
            background: #27ae60;
        }

        #status {
            margin-top: 10px;
            font-size: 18px;
            color: #007acc;
        }

        .hiddenVideo {
            width: 1px !important;
            height: 1px !important;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            z-index: -1 !important;
            background: black !important;
            object-fit: cover !important;
            user-select: none !important;
            pointer-events: none !important;
        }

        #debugCanvas {
            max-width: 100%;
            margin-top: 10px;
            border: 1px dashed #ccc;
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <nav>
            <a href="/hand_tracking" class="active">–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–π —Ä—É–∫ </a>
            <a href="/files_processing">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø–∏—Å–µ–π</a>
        </nav>
        <h1>üëã –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏–π —Ä—É–∫</h1>

        <div class="video-container">
            <div class="video-box">
                <video id="localVideo" autoplay muted playsinline class="hiddenVideo"></video>
            </div>
            <div class="video-box">
                <img id="processedVideo" alt="Processed Stream" />
            </div>
        </div>

        <div class="controls">
            <button id="startBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="stopBtn">‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É</button>
            <button id="recordBtn">üî¥ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        </div>

        <div class="settings">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
            <label>
                Hand Detection Confidence:
                <input type="range" id="confidenceSlider" min="0.1" max="1.0" step="0.1" value="0.6">
                <span class="settings-value" id="confidenceValue">0.6</span>
            </label>
        </div>

        <div id="status">–°—Ç–∞—Ç—É—Å: –≥–æ—Ç–æ–≤–æ</div>
    </div>

    <canvas id="debugCanvas" width="640" height="480"></canvas>

    <script>
        const localVideo = document.getElementById("localVideo");
        const processedVideo = document.getElementById("processedVideo");
        const debugCanvas = document.getElementById("debugCanvas");
        const debugCtx = debugCanvas.getContext("2d");
        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");
        const recordBtn = document.getElementById("recordBtn");
        const statusDiv = document.getElementById("status");
        const confidenceSlider = document.getElementById("confidenceSlider");
        const confidenceValue = document.getElementById("confidenceValue");

        let ws;
        let recording = false;
        let cameraActive = false;
        let frameAnimationId = null;
        let currentSettings = {
            confidence: 0.6
        };

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        function updateStatus(msg) {
            statusDiv.textContent = "–°—Ç–∞—Ç—É—Å: " + msg;
            console.log("[–°—Ç–∞—Ç—É—Å]", msg);
        }

        confidenceSlider.addEventListener('input', (e) => {
            currentSettings.confidence = parseFloat(e.target.value);
            confidenceValue.textContent = currentSettings.confidence.toFixed(1);
        });

        async function startCamera() {
            if (cameraActive) return;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });

                localVideo.srcObject = stream;
                cameraActive = true;

                localVideo.onloadedmetadata = () => {
                    console.log("üé• –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:", localVideo.videoWidth, "x", localVideo.videoHeight);
                    if (localVideo.videoWidth === 0 || localVideo.videoHeight === 0) {
                        updateStatus("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≤–∏–¥–µ–æ");
                        stopCamera();
                        return;
                    }
                    connectWebSocket();
                };

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                updateStatus("–ö–∞–º–µ—Ä–∞ –∑–∞–ø—É—â–µ–Ω–∞");

            } catch (err) {
                console.error("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ:", err);
                updateStatus("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã: " + (err.message || "–¥–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω"));
                startBtn.disabled = false;
            }
        }

        function stopCamera() {
            if (!cameraActive) return;

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É –∫–∞–¥—Ä–æ–≤
            if (frameAnimationId) {
                cancelAnimationFrame(frameAnimationId);
                frameAnimationId = null;
            }

            // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (ws) {
                ws.close();
                ws = null;
            }

            // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ—Ç–æ–∫ –∫–∞–º–µ—Ä—ã
            if (localVideo.srcObject) {
                const tracks = localVideo.srcObject.getTracks();
                tracks.forEach(track => track.stop());
                localVideo.srcObject = null;
            }

            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            processedVideo.src = '';

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            cameraActive = false;
            recording = false;
            recordBtn.textContent = "üî¥ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å";
            recordBtn.classList.remove('recording');

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞, —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            startBtn.disabled = false;

            updateStatus("–ö–∞–º–µ—Ä–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
        }

        function connectWebSocket() {
            const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
            ws = new WebSocket(protocol + window.location.host + "/ws");

            ws.onopen = () => {
                updateStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
                startSendingFrames();
            };

            ws.onmessage = (event) => {
                if (event.data && event.data.startsWith("data:image")) {
                    processedVideo.src = event.data;
                } else {
                    console.warn("–ü–æ–ª—É—á–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:", event.data);
                }
            };

            ws.onerror = (err) => {
                console.error("‚ùå –û—à–∏–±–∫–∞ WebSocket:", err);
                updateStatus("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è");
            };

            ws.onclose = () => {
                updateStatus("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ");
                if (cameraActive) {
                    // –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –≤—Å–µ –µ—â–µ –∞–∫—Ç–∏–≤–Ω–∞, –ø—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                    setTimeout(connectWebSocket, 2000);
                }
            };
        }

        function startSendingFrames() {
            const FRAME_RATE = 30;
            const FRAME_INTERVAL = 1000 / FRAME_RATE;
            let lastSendTime = 0;

            const sendFrame = (timestamp) => {
                if (!cameraActive) return;

                if (!lastSendTime) lastSendTime = timestamp;
                const elapsed = timestamp - lastSendTime;

                if (elapsed < FRAME_INTERVAL) {
                    frameAnimationId = requestAnimationFrame(sendFrame);
                    return;
                }

                if (!localVideo.srcObject || localVideo.readyState < HTMLMediaElement.HAVE_CURRENT_DATA) {
                    frameAnimationId = requestAnimationFrame(sendFrame);
                    return;
                }

                canvas.width = localVideo.videoWidth;
                canvas.height = localVideo.videoHeight;
                ctx.drawImage(localVideo, 0, 0, canvas.width, canvas.height);

                const dataUrl = canvas.toDataURL("image/jpeg", 0.5);
                const base64Data = dataUrl.split(",")[1];

                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(base64Data);
                }

                lastSendTime = timestamp;
                frameAnimationId = requestAnimationFrame(sendFrame);
            };

            frameAnimationId = requestAnimationFrame(sendFrame);
        }

        startBtn.onclick = () => {
            startBtn.disabled = true;
            startCamera();
        };

        stopBtn.onclick = () => {
            stopCamera();
        };

        recordBtn.onclick = async () => {
            if (!cameraActive) {
                updateStatus("–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–∞–º–µ—Ä—É");
                return;
            }

            if (!recording) {
                try {
                    const resp = await fetch("/start_record", { method: "POST" });
                    const data = await resp.json();
                    if (data.status === "started") {
                        recording = true;
                        recordBtn.textContent = "‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å";
                        recordBtn.classList.add('recording');
                        updateStatus("–ò–¥—ë—Ç –∑–∞–ø–∏—Å—å...");
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ –∑–∞–ø–∏—Å–∏:", err);
                    updateStatus("–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏");
                }
            } else {
                try {
                    const resp = await fetch("/stop_record", { method: "POST" });
                    const data = await resp.json();
                    recording = false;
                    recordBtn.textContent = "üî¥ –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å";
                    recordBtn.classList.remove('recording');
                    if (data.saved_file) {
                        updateStatus("–ó–∞–ø–∏—Å—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: " + data.saved_file.split("/").pop());
                    } else {
                        updateStatus("–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞");
                    }
                } catch (err) {
                    console.error("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–ø–∏—Å–∏:", err);
                    updateStatus("–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏");
                }
            }
        };

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });
    </script>
</body>

</html>